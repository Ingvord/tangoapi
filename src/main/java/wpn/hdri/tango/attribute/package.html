<!--
  ~ The main contributor to this project is Institute of Materials Research,
  ~ Helmholtz-Zentrum Geesthacht,
  ~ Germany.
  ~
  ~ This project is a contribution of the Helmholtz Association Centres and
  ~ Technische Universitaet Muenchen to the ESS Design Update Phase.
  ~
  ~ The project's funding reference is FKZ05E11CG1.
  ~
  ~ Copyright (c) 2012. Institute of Materials Research,
  ~ Helmholtz-Zentrum Geesthacht,
  ~ Germany.
  ~
  ~ This program is free software; you can redistribute it and/or
  ~ modify it under the terms of the GNU General Public License
  ~ as published by the Free Software Foundation; either version 2
  ~ of the License, or (at your option) any later version.
  ~
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ~ GNU General Public License for more details.
  ~
  ~ You should have received a copy of the GNU General Public License
  ~ along with this program; if not, write to the Free Software
  ~ Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA
  -->

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>Extended Tango Java API</title>
</head>
<body>
<p>
    This is attribute framework. It simplifies definition and usage of attributes in Tango servers. Main class
    which user will use in this framework is {@link wpn.hdri.tango.attribute.TangoAttribute}.
</p>

<p>User creates an instance of TangoAttribute by calling the following constructor: {@link
    wpn.hdri.tango.attribute.TangoAttribute#TangoAttribute(String, wpn.hdri.tango.data.format.TangoDataFormat,
    wpn.hdri.tango.data.type.TangoDataType, EnumAttrWriteType, TangoAttributeListener)}</p>
    <pre>
        public TangoAttribute&lt;T&gt;(
            String name,
            TangoDataFormat&lt;T&gt; format,
            TangoDataType&lt;T&gt; type,
            EnumAttrWriteType writeType,
            &amp;Nullable TangoAttributeListener&lt;T&gt; listener)
    </pre>
<p>
    - where:</p>
<ul>
    <li>&lt;T&gt; - is a type of underlying value;</li>
    <li>name - a name of the attribute;</li>
    <li>format - an instance of ScalarTangoDataFormat or SpectrumTangoDataFormat or ImageTangoDataFormat;</li>
    <li>type - an instance of ScalarTangoDataType or SpectrumTangoDataType or ImageTangoDataType;</li>
    <li>writeType - one of the EnumAttrWriteType (READ, READ_WRITE, etc);</li>
    <li>listener - an implementation of the TangoAttributeListener.</li>
</ul>

<p>
    listener parameter of the constructor is very important. It allows to implement different logic for storing and
    retrieving attribute's value.
    For instance, one can use embedded DB for storing attribute values or implement a custom event mechanism.
</p>

<h2>Usage examples:</h2>

<p>
    One can predefine a number of attributes for his server in a enum MyAttribute:
</p>
    <pre>
        //MyAttribute.java
        enum MyAttribute{
            ATTR1(new TangoAttribute(
                "MyAttribute",TangoDataFormat.createScalarDataFormat(),ScalarTangoDataTypes.STRING,EnumAttrWriteType.READ_WRITE,null));

            private final TangoAttribute tangoAttribute;

            ...

            public TangoAttribute toAttr(){
                return tangoAttribute.toAttr();
            }
        }
        </pre>
<p>The following code should be added to one's tango server class:</p>
    <pre>
        //MyTangoServer.java
        private final Map&lt;String, TangoAttribute&lt;?&gt;&gt; attributes = new HashMap&lt;String, TangoAttribute&lt;?&gt;&gt;()
        ...
        public void init_device() throws DevFailed {
            for(MyAttribute attr : MyAttribute.values()){
                add_attribute(attr.toAttr().toAttr());//add Attr to device attributes list
                attributes.put(attr.toAttr().getName(),attr.toAttr());//add TangoAttribute to local attributes map
            }
        }
        ...
        public void read_attr(Attribute attr) throws DevFailed {
            String attr_name = attr.get_name();

            TangoAttribute<?> attribute = attributes.get(attr_name);

            attribute.read(attr);
        }
        ...
        public void write_attr(WAttribute attr) throws DevFailed {
            String attr_name = attr.get_name();

            TangoAttribute<?> attribute = attributes.get(attr_name);

            attribute.write(attr);
        }
        ...
    </pre>
<p>
    Now defining a new attribute is only a matter of adding new enum constant.
</p>
<hr/>
<p>The following example demonstrates a technique of using TangoAttributeChangeListener to implement a custom storage
    for attribute values:</p>

<p>Suppose we have some MetaInfo where our attributes are defined. And suppose we have Storage interface which
    implementation stores attribute value somewhere, e.g. local file system or remote db.
    In tango server init_device method we are parsing MetaInfo and creating a new TangoAttribute for each entity:</p>
    <pre>
        //MyTangoServer.java
        private final Storage<?> storage;
        private final Map&lt;String, TangoAttribute<?>> attributes = new HashMap&lt;String, TangoAttribute<?>>();
        ...
        public void init_device() throws DevFailed {
            for(MetaEntity entity : MetaInfo.getEntities()){
                attributes.put(entity.getName(),createTangoAttributeFromMetaEntity(entity));
            }
        }
        ...
        private createTangoAttributeFromMetaEntity(final MetaEntity entity){
            return new TangoAttribute(entity.getName(),entity.getFormat(),entity.getType(),EnumAttrWriteType.READ_WRITE,
                 new TangoAttributeListener&lt;Object>() {

                    public Object onLoad() {
                        Object value = storage.getValue(entity);
                        return value;
                    }

                    public void onSave(Object value) {
                        storage.setValue(entity, value);
                    }
            );
        }
        ...
        public void read_attr(Attribute attr) throws DevFailed {
            String attr_name = attr.get_name();

            TangoAttribute<?> attribute = attributes.get(attr_name);

            attribute.read(attr);
        }
        ...
        public void write_attr(WAttribute attr) throws DevFailed {
            String attr_name = attr.get_name();

            TangoAttribute<?> attribute = attributes.get(attr_name);

            attribute.write(attr);
        }
        ...
    </pre>
<p>Now when client accesses MyTangoServer/some-entity-attribute for reading the value is being read from storage; for
    writing - it is being written to storage.</p>
<hr/>
</body>
</html>